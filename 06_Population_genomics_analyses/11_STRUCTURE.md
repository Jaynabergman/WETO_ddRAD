# STRUCTURE

## Background
To model clusters based on allele frequencies we will use the program STRUCTURE (Prichard et al., 2000) and run it in Digital Research Alliance of Canada (DRAC). The following DRAC website (https://docs.alliancecan.ca/wiki/Structure) has steps and python scripts to run STRUCTURE and STRUCTURE Harvester (to choose the best fit k). Visit the website for where to download the scripts and how to run them.

## STRUCTURE input file
We will use *populations* in **STACKS** to get the structure input file from the filtered vcf file. (output will be a file with a .str ending)

populations_str.sh
```
#!/bin/bash
#SBATCH -c 4
#SBATCH --mem=28GB
#SBATCH --time=10:00:00
#SBATCH -o str_%A.out
#SBATCH -e str_%A.err
#SBATCH --mail-type=BEGIN,END,FAIL
#SBATCH --mail-user=EMAIL


vcf=$1
outfolder=$2
popmap=$3


mkdir $outfolder


~/local/bin/populations -V $vcf -O $outfolder --popmap $popmap --fstats --structure --vcf
```
## STRUCTURE 

### Files & inputs 
1) create_strauto_slurm_scripts.py
2) input.py
3) strauto_1.py
4) harvesterCore.py
5) structureHarvester.py
6) filename.str


### Steps
1. Edit structure file by removing the header line (first line in the file) and change the file extension to .str
  
2. Load the following modules in the command line:
- module load StdEnv/2020
- module load gcc/9.3.0
- module load structure/2.3.4
- module load python/2.7.18
  
3. Type in the command line: chmod u+x create_strauto_slurm_scripts.py

4. Edit the input.py file:
- change burnin (i.e. 300,000)
- Change mcmc (i.e. 1,000,000)
- number of individuals
- number of loci
- max number of populations
- number of kruns

5. Type in the command line: ./strauto_1.py (follow instructions)

6. Type in the command line: ./create_strauto_slurm_scripts.py

7. Type in the command line: bash submit_strauto_jobs.sh

8. Once all jobs have completed - type in the command line: bash post_strauto.sh

### Outputs 
Folder: *results_f* which has the cluster frequencies for each k run  
Folder: *harvester* which has the evanno k information to get the best fit k  

## Next steps
1. Make plots in R to look at the Delta K value (generated by the Evanno method) to determine the best fit k (number of populations).
2. Upload results (from results_f folder) to the CLUMPAK website.
3. Make STRUCTURE plot with this data for relevant k values in R. (see rmd file *04_STRUCTURE.rmd*)
